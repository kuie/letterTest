<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB操作</title>
</head>
<body>
<label><input type="text"></label>
<button id="create">新建表student</button>
<button id="add">批量新增student</button>
<button id="delete">关键词搜索删除</button>
<button id="search">测试查询</button>
<button id="fuzzySearch">模糊查询</button>
<table id="table"></table>
<script>
    function getRandom(max, min) {
        max = max || 100;
        min = min || 0;
        return Math.floor(min + Math.random() * max);
    }
    var indexedDB = window.indexedDB || window.msIndexedDB || window.mozIndexedDB || window.webkitIndexedDB,
        dbName = "MyDatabase",
        tableName = 'students',
        addData = [
            {uid: getRandom(9999), name: "qwer", email: "@qq.com"},
            {uid: getRandom(9999), name: "asdf", email: "@163.com"},
            {uid: getRandom(9999), name: "zxcv", email: "@sina.com"},
            {uid: getRandom(9999), name: "tyuo", email: "@live.com"},
            {uid: getRandom(9999), name: "ghjk", email: "@baidu.com"}
        ],
        Btn_create = document.getElementById('create'),
        Btn_add = document.getElementById('add'),
        Btn_delete = document.getElementById('delete'),
        Btn_search = document.getElementById('search'),
        Btn_fuzzy = document.getElementById('fuzzySearch'),
        input = document.getElementsByTagName('input')[0];
    //初始化数据库
    indexedDB.__proto__.create = function (dbName, tableConfig) {
        var request = this.open(dbName);
        request.onerror = DBError;
        /*创建数据库*/
        request.onupgradeneeded = function (event) {
            var db = event.target.result;
            tableConfig.autoIncrement = tableConfig.autoIncrement || true;
            //创建存储对象（表）,以id字段作为主键来确保唯一,使用keyPath表示
            var objectStore = db.createObjectStore(tableConfig.tableName, {
                keyPath: tableConfig.MainKey,
                autoIncrement: tableConfig.autoIncrement
            });
            console.log('主键：' + tableConfig.MainKey + '\n是否自增：' + tableConfig.autoIncrement);
            //给表添加索引
            for (var i in tableConfig.Keys) {
                console.log('字段：' + i);
                objectStore.createIndex(i, i, {unique: !!tableConfig.Keys[i]});//是否不可重复
                if (tableConfig.Keys[i]) {
                    console.log('数据唯一');
                } else {
                    console.log('数据不唯一');
                }
            }
            console.log("---新建数据库成功---");
        }
    };
    indexedDB.__proto__.add = function (dbName, tableName, data) {
        var request = this.open(dbName);
//打开数据库失败的回调
        request.onerror = DBError;
//代开数据成功的回调
        request.onsuccess = function (event) {
            var db = event.target.result,
                transaction = db.transaction(tableName, 'readwrite');
            transaction.onerror = function (event) {
                //处理错误
//                console.error(new Error('transaction错误！！'));
            };
            /*中断*/
            transaction.onbort = function () {
                //事务中断处理
                console.log('处理中断');
            };
            /*完成*/
            transaction.oncomplete = function () {
                console.log("添加数据成功");
                db.close();
            };
            var objectStore = transaction.objectStore(tableName);
            for (var i  in data) {
                var request = objectStore.add(data[i]);
                request.onsuccess = function () {
                    console.log("成功添加一条数据");
                };
                request.onabort = function () {
                    console.log('数据添加中断');
                };
                request.onerror = function () {
                    console.log('添加数据一条失败');
                }
            }
        };
    };
    indexedDB.__proto__.del = function (dbName, tableName, delArray) {
        /*默认通过主键值进行删除*/
        var request = this.open(dbName);
        request.onerror = DBError;
        request.onsuccess = function (event) {
            var objectStore,
                transaction,
                db = event.target.result;
            transaction = db.transaction([tableName], 'readwrite');
            transaction.onerror = function (event) {
                //处理错误
                console.log("删除失败" + event.target.errorCode);
            };
            transaction.onbort = function () {
                //事务中断处理
                alert('处理中断');
            };
            transaction.oncomplete = function () {
                if (delArray instanceof Array) {
                    console.log("删除" + delArray.join("、") + "成功");
                } else {
                    console.log("删除" + delArray + "成功");
                }
            };
            objectStore = transaction.objectStore(tableName);
            console.log(objectStore);
            if (delArray instanceof Array) {
                for (var i = 0; i < delArray.length; i++) {
                    /*只能按照主键值删除数据*/
                    objectStore.delete(delArray[i] - 0);
                }
            } else {
                objectStore.delete(delArray - 0);
            }
            db.close();
        };
    };
    indexedDB.__proto__.search = function (dbName, tableName, searchConfig) {
        var request = this.open(dbName);
        request.onerror = DBError;
        request.onsuccess = function (event) {
            var db = event.target.result,
                transaction = db.transaction(tableName, "readonly"),
                objectStore = transaction.objectStore(tableName),
                index, IDB;
            /*创建游标*/
            if (searchConfig.range && searchConfig.range.key) {
                index = objectStore.index(searchConfig.range.key);
                IDB = searchConfig.range.IDB || null;
            } else {
                index = objectStore;
                IDB = searchConfig.range && searchConfig.range.IDB || null;
            }
            var OpenCursor = index.openCursor(IDB),
                resultArray = [];
            OpenCursor.onsuccess = function (event) {
                var cursor = event.target.result, searchKey;
                /*对象查找获取对象的key和value*/
                if (typeof searchConfig.keyword === 'object') {
                    searchConfig.keyword = objParsing(searchConfig.keyword).val;
                    searchKey = objParsing(searchConfig.keyword).key;
                }
                /*判断是否模糊查询*/
                var reg = searchConfig.isFuzzy ? new RegExp(searchConfig.keyword, 'g') : new RegExp('^' + searchConfig.keyword + '$', 'g');
                if (cursor) {
                    switch (typeof searchConfig.keyword) {
                        case 'string':
                            (function () {
                                for (var key in cursor.value) {
                                    if (reg.test(cursor.value[key])) {
                                        resultArray.push(cursor.value);
                                        /*防止重复推入一条数据*/
                                        break;
                                    }
                                }
                            })();
                            break;
                        case 'object':
                            objSearch(reg, resultArray, searchConfig.keyword[searchKey], cursor.value);
                            break;
                        case 'undefined':
                            resultArray.push(cursor.value);
                            break;
                    }
                    cursor.continue();
                } else {
                    /*执行数据操作*/
                    if (searchConfig.fun)return searchConfig.fun(resultArray, searchConfig.funArguments);
                    db.close();
                }
            };
        }
    };
    /*对象拆解*/
    function objParsing(obj) {
        var result = {};
        for (var k in obj) {
            result.val = obj[k];
            result.key = k;
        }
        return result;
    }
    function objSearch(reg, arr, key, val) {
        /*判别keyword筛选的项目*/
        return val[key] && reg.test(val[key]) && arr.push(val);
    }
    Btn_create.onclick = function () {//打开数据库失败的回调
        indexedDB.create(dbName, {
            /*表名称*/
            tableName: tableName,
            /*可索引队列-->数据唯一性：默认为false，可重复*/
            Keys: {'name': false, 'email': false, 'uid': false},
            /*主键是否自增，默认为true(设置为false后如没有指定该属性值则维持自增，自增值为主键所存在的length值)*/
            autoIncrement: false,
            /*主键：必须属性*/
            MainKey: 'id'
        });
    };
    Btn_add.onclick = function () {
        indexedDB.add(dbName, tableName, addData);
    };
    Btn_delete.onclick = function () {
        var config = {
            keyword: input.value[0] === '{' ? eval(input.value) : input.value,
            fun: queryDel,
            funArguments: {dbName: dbName, tableName: tableName},
            isFuzzy: false
        };
        indexedDB.search(dbName, tableName, config);
    };
    Btn_search.onclick = function () {
        /*查询测试*/
        var request = indexedDB.open(dbName);
        request.onerror = DBError;
        request.onsuccess = function (event) {
            var db = event.target.result,
                transaction = db.transaction(tableName, "readonly"),
                objectStore = transaction.objectStore(tableName),
                request1 = objectStore.get(2);
            request1.onsuccess = function (e) {
                var data = e.target.result;
                console.log(data);
            };
        }
    };
    Btn_fuzzy.onclick = function () {
        var config = {
            /*关键词*/
            keyword: input.value[0] === '{' ? eval(input.value) : input.value,
            /*索引键值*/
            sortIndex: 'uid',
            /*是否模糊*/
            isFuzzy: true,
            /*回调函数*/
            fun: function (result) {
                var html = '<tr><td>id</td><td>uid</td><td>name</td><td>email</td></tr>';
                for (var i = 0; i < result.length; i++) {
                    html += '<tr><td>' + result[i].id + '</td><td>' + result[i].uid + '</td><td>' + result[i].name + '</td><td>' + result[i].email + '</td></tr>'
                }
                document.getElementById('table').innerHTML = html;
            },
            /*如没有range对象则不设置额外的过滤属性*/
            range: {
                /*过滤对象方法
                 IDBKeyRange.lowerBound(any,bool)小于//
                 IDBKeyRange.upperBound(any,bool)大于//
                 IDBKeyRange.bound(any,any,bool,bool)//之间
                 IDBKeyRange.only(any)//等于
                 */
                IDB: IDBKeyRange.bound(0, 4000, true, true),
                /*过滤键值*/
                key: 'uid'
            }
        };
        indexedDB.search(dbName, tableName, config);
    };
    function DBError() {
        console.log('数据库链接出现错误');
    }
    /*模糊查询*/
    function queryDel(Array, funArguments) {
        indexedDB.del(funArguments.dbName, funArguments.tableName, getMainKey(Array));
    }
    function getMainKey(Array) {
        var arr = [];
        for (var i = 0; i < Array.length; i++) {
            arr[i] = Array[i].id;
        }
        console.log(arr);
        return arr;
    }
</script>
</body>
</html>