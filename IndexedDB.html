<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB操作</title>
</head>
<body>
<label><input type="text"></label>
<button id="create">新建表student</button>
<button id="add">批量新增student</button>
<button id="delete">Id删除</button>
<button id="search">keyword删除</button>
<button id="fuzzySearch">模糊查询</button>
<script>
    function getRandom(max, min) {
        max = max || 100;
        min = min || 0;
        return Math.floor(min + Math.random() * max);
    }
    var indexedDB = window.indexedDB || window.msIndexedDB || window.mozIndexedDB || window.webkitIndexedDB,
        dbName = "MyDatabase",
        tableName = 'students',
        addData = [
            {uid: getRandom(9999), name: "qwer", email: "@qq.com"},
            {uid: getRandom(9999), name: "asdf", email: "@163.com"},
            {uid: getRandom(9999), name: "zxcv", email: "@sina.com"},
            {uid: getRandom(9999), name: "tyuo", email: "@live.com"},
            {uid: getRandom(9999), name: "ghjk", email: "@baidu.com"}
        ],
        Btn_create = document.getElementById('create'),
        Btn_add = document.getElementById('add'),
        Btn_delete = document.getElementById('delete'),
        Btn_search = document.getElementById('search'),
        Btn_fuzzy = document.getElementById('fuzzySearch'),
        input = document.getElementsByTagName('input')[0];
    //初始化数据库
    indexedDB.__proto__.create = function (dbName, tableConfig) {
        var request = this.open(dbName);
        request.onerror = DBError;
        request.onupgradeneeded = function (event) {
            var db = event.target.result;
            //创建表,以id字段作为主键来确保唯一,使用keyPath表示
            tableConfig.autoIncrement = tableConfig.autoIncrement || true;
            var objectStore = db.createObjectStore(tableConfig.tableName, {
                keyPath: tableConfig.MainKey,
                autoIncrement: tableConfig.autoIncrement
            });
            console.log('主键：' + tableConfig.MainKey + '\n是否自增：' + tableConfig.autoIncrement);
            //给表添加索引
            for (var i in tableConfig.Keys) {
                console.log('字段：' + i);
                if (tableConfig.Keys[i]) {
                    objectStore.createIndex(i, i, {unique: true});//非unique索引
                    console.log('数据唯一');
                } else {
                    console.log('数据不唯一');
                }
            }
            console.log("---新建数据库成功---");
        }
    };
    indexedDB.__proto__.add = function (dbName, tableName, data) {
        var request = this.open(dbName);
//打开数据库失败的回调
        request.onerror = DBError;
//代开数据成功的回调
        request.onsuccess = function (event) {
            var db = event.target.result,
                transaction = db.transaction(tableName, 'readwrite');
            transaction.onerror = function (event) {
                //处理错误
//                console.error(new Error('transaction错误！！'));
            };
            /*中断*/
            transaction.onbort = function () {
                //事务中断处理
                console.log('处理中断');
            };
            /*完成*/
            transaction.oncomplete = function () {
                console.log("添加数据成功");
            };
            var objectStore = transaction.objectStore(tableName);
            for (var i  in data) {
                var request = objectStore.add(data[i]);
                request.onsuccess = function () {
                    console.log("成功添加一条数据");
                };
                request.onabort = function () {
                    console.log('数据添加中断');
                };
                request.onerror = function () {
                    console.log('添加数据一条失败');
                }
            }
        };
    };
    indexedDB.__proto__.del = function (dbName, tableName, delArray) {
        /*默认通过主键值进行删除*/
        var request = this.open(dbName);
        request.onerror = DBError;
        request.onsuccess = function (event) {
            var objectStore,
                transaction,
                db = event.target.result;
            transaction = db.transaction([tableName], 'readwrite');
            transaction.onerror = function (event) {
                //处理错误
                console.log("删除失败" + event.target.errorCode);
            };
            transaction.onbort = function () {
                //事务中断处理
                alert('处理中断');
            };
            transaction.oncomplete = function () {
                if (delArray instanceof Array) {
                    console.log("删除" + delArray.join("、") + "成功");
                } else {
                    console.log("删除" + delArray + "成功");
                }
            };
            objectStore = transaction.objectStore(tableName);
            console.log(objectStore);
            if (delArray instanceof Array) {
                for (var i = 0; i < delArray.length; i++) {
                    /*只能按照主键值删除数据*/
                    objectStore.delete(delArray[i] - 0);
                }
            } else {
                objectStore.delete(delArray - 0);
            }
        };
    };
    indexedDB.__proto__.search = function (dbName, tableName, searchConfig) {
        var request = indexedDB.open(dbName);
        request.onerror = DBError;
        request.onsuccess = function (event) {
            var db = event.target.result,
                transaction = db.transaction(tableName, "readonly"),
                objectStore = transaction.objectStore(tableName),
                OpenCursor = objectStore.openCursor(),
                resultArray = [];
            OpenCursor.onsuccess = function (event) {
                var cursor = event.target.result, searchKey;
                if (typeof searchConfig.keyword === 'object') {
                    for (var k in searchConfig.keyword) {
                        searchConfig.keyword = searchConfig.keyword[k];
                        searchKey = k;
                    }
                }
                /*判断是否模糊查询*/
                var reg = searchConfig.isFuzzy ? new RegExp(searchConfig.keyword, 'g') : new RegExp('^' + searchConfig.keyword + '$', 'g');
                if (cursor) {
                    switch (typeof searchConfig.keyword) {
                        case 'string':
                            (function () {
                                for (var key in cursor.value) {
                                    reg.test(cursor.value[key]) && resultArray.push(cursor.value);
                                }
                            })();
                            cursor.continue();
                            break;
                        case 'object':
                            (function () {
                                /*判别keyword筛选的项目数量*/
                                if (cursor.value[searchConfig.keyword[searchKey]]) {
                                    reg.test(cursor.value[searchConfig.keyword[searchKey]]) && resultArray.push(cursor.value);
                                }
                            })();
                            cursor.continue();
                            break;
                    }
                } else {
                    /*执行数据操作*/
                    console.log(resultArray);
                    if (searchConfig.fun)return searchConfig.fun(resultArray, searchConfig.funArguments);
                }
            };
        }
    };
    Btn_create.onclick = function () {//打开数据库失败的回调
        indexedDB.create(dbName, {
            /*表名称*/
            tableName: tableName,
            /*数据唯一性：默认为false，可重复*/
            Keys: {'name': false, 'email': false},
            /*主键是否自增，默认为true(设置为false后如没有指定该属性值则维持自增，自增值为主键所存在的length值)*/
            autoIncrement: false,
            /*主键：必须属性*/
            MainKey: 'id'
        });
    };
    Btn_add.onclick = function () {
        indexedDB.add(dbName, tableName, addData);
    };
    Btn_delete.onclick = function () {
        indexedDB.del(dbName, tableName, input.value);
    };
    Btn_search.onclick = function () {
        var config = {
            keyword: input.value[0] === '{' ? eval(input.value) : input.value,
            fun: queryDel,
            funArguments: {dbName: dbName, tableName: tableName},
            isFuzzy: false
        };
        indexedDB.search(dbName, tableName, config);
    };
    Btn_fuzzy.onclick = function () {
        var config = {
            keyword: input.value[0] === '{' ? eval(input.value) : input.value,
            isFuzzy: true
        };
        indexedDB.search(dbName, tableName, config);
    };
    function DBError() {
        console.log('数据库链接出现错误');
    }
    /*模糊查询 未完成！！*/
    function queryDel(Array, funArguments) {
        indexedDB.del(funArguments.dbName, funArguments.tableName, getMainKey(Array));
    }
    function getMainKey(Array) {
        var arr = [];
        for (var i = 0; i < Array.length; i++) {
            arr[i] = Array[i].id;
        }
        console.log(arr);
        return arr;
    }
</script>
</body>
</html>